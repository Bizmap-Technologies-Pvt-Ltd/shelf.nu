<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID WebSocket Test</title>
</head>
<body>
    <h1>RFID WebSocket Test</h1>
    <div id="status">Disconnected</div>
    <div id="messages"></div>
    
    <div>
        <button id="connect">Connect</button>
        <button id="disconnect">Disconnect</button>
        <button id="startSession">Start Session</button>
        <button id="endSession">End Session</button>
    </div>
    
    <div>
        <input type="text" id="rfidTag" placeholder="Enter RFID tag" value="test-tag-123">
        <button id="scanTag">Scan Tag</button>
    </div>

    <script>
        let ws = null;
        let sessionId = null;
        
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        
        function log(message) {
            console.log(message);
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${JSON.stringify(message)}`;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function connect() {
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket('ws://localhost:3001/rfid-stream');
            
            ws.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.style.color = 'green';
                log('WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                log(`Received: ${message.type} - ${JSON.stringify(message)}`);
                
                if (message.type === 'SESSION_STARTED') {
                    sessionId = message.sessionId;
                }
            };
            
            ws.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.style.color = 'red';
                log('WebSocket disconnected');
                sessionId = null;
            };
            
            ws.onerror = (error) => {
                statusEl.textContent = 'Error';
                statusEl.style.color = 'red';
                log(`WebSocket error: ${error}`);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function startSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected');
                return;
            }
            
            const newSessionId = crypto.randomUUID();
            ws.send(JSON.stringify({
                type: 'START_SESSION',
                sessionId: newSessionId,
                timestamp: Date.now()
            }));
            log(`Sent START_SESSION: ${newSessionId}`);
        }
        
        function endSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !sessionId) {
                log('No active session');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'END_SESSION',
                sessionId: sessionId,
                timestamp: Date.now()
            }));
            log(`Sent END_SESSION: ${sessionId}`);
        }
        
        function scanTag() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !sessionId) {
                log('No active session');
                return;
            }
            
            const rfidTag = document.getElementById('rfidTag').value;
            if (!rfidTag) {
                log('Please enter an RFID tag');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'SCAN_RFID',
                sessionId: sessionId,
                rfidTag: rfidTag,
                timestamp: Date.now()
            }));
            log(`Sent SCAN_RFID: ${rfidTag}`);
        }
        
        // Event listeners
        document.getElementById('connect').onclick = connect;
        document.getElementById('disconnect').onclick = disconnect;
        document.getElementById('startSession').onclick = startSession;
        document.getElementById('endSession').onclick = endSession;
        document.getElementById('scanTag').onclick = scanTag;
        
        // Auto-connect on load
        connect();
    </script>
</body>
</html>
